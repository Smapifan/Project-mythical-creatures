name: SMAPI Mod Builder

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # 1Ô∏è‚É£ Repo klonen
    - name: Checkout repo
      uses: actions/checkout@v4

    # 2Ô∏è‚É£ .NET 6 installieren
    - name: Setup .NET 6
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '6.0.x'

    # 3Ô∏è‚É£ Tools installieren
    - name: Install tools
      run: sudo apt-get update && sudo apt-get install -y jq

    # 4Ô∏è‚É£ Ordner vorbereiten
    - name: Prepare folders
      run: |
        rm -rf ModBuilder/temp_build
        mkdir -p ModBuilder/temp_build/ModTemplate
        mkdir -p ModBuilder/output/logs
        mkdir -p ModBuilder/output/build

    # 5Ô∏è‚É£ ModEntry.cs erstellen
    - name: Generate ModEntry.cs
      run: |
        cat > ModBuilder/temp_build/ModTemplate/ModEntry.cs << 'EOF'
using StardewModdingAPI;

namespace MyModTemplate
{
    public class ModEntry : Mod
    {
        public override void Entry(IModHelper helper)
        {
            Monitor.Log("Mod gestartet!", LogLevel.Info);
        }
    }
}
EOF

    # 6Ô∏è‚É£ manifest.json erstellen
    - name: Generate manifest.json
      run: |
        cat > ModBuilder/temp_build/ModTemplate/manifest.json << 'EOF'
{
  "Name": "MyModTemplate",
  "Author": "Smapifan",
  "Version": "1.0.0",
  "Description": "Automatisch erstellte Mod Vorlage",
  "UniqueID": "Smapifan.MyModTemplate",
  "EntryDll": "MyModTemplate.dll",
  "MinimumApiVersion": "3.0.0"
}
EOF

    # 7Ô∏è‚É£ CSProj erstellen
    - name: Generate csproj
      run: |
        cat > ModBuilder/temp_build/ModTemplate/MyModTemplate.csproj << 'EOF'
<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <TargetFramework>net6.0</TargetFramework>
    <GamePath>$GITHUB_WORKSPACE/DLL-Builder/input/stardew</GamePath>
    <OutputType>Library</OutputType>
  </PropertyGroup>
  <ItemGroup>
    <PackageReference Include="Pathoschild.Stardew.ModBuildConfig" Version="4.4.0" />
    <PackageReference Include="StardewModdingAPI" Version="3.17.0" />
  </ItemGroup>
</Project>
EOF

    # 8Ô∏è‚É£ SLN erstellen und CSProj hinzuf√ºgen
    - name: Generate SLN
      run: |
        cd ModBuilder/temp_build/ModTemplate
        dotnet new sln --name MyModTemplate
        dotnet sln add MyModTemplate.csproj

    # 9Ô∏è‚É£ Build mit GamePath und Log
    - name: Build SMAPI Mod
      run: |
        CS_PROJECT=$(find ModBuilder/temp_build -name "*.csproj" | head -n 1)
        dotnet build "$CS_PROJECT" -c Release \
          -p:GamePath="$GITHUB_WORKSPACE/DLL-Builder/input/stardew" \
          | tee ModBuilder/output/logs/build.log || true

    # üîü Mod-Dateien sammeln
    - name: Collect mod output
      run: |
        MOD_DIR=$(dirname "$CS_PROJECT")
        BUILD_OUT=ModBuilder/output/build/MyModTemplate
        mkdir -p "$BUILD_OUT"

        # DLL kopieren
        find "$MOD_DIR/bin/Release" -name "*.dll" -exec cp {} "$BUILD_OUT" \;

        # manifest.json kopieren
        cp "$MOD_DIR/manifest.json" "$BUILD_OUT"

    # 1Ô∏è‚É£1Ô∏è‚É£ Logs hochladen
    - name: Upload logs
      uses: actions/upload-artifact@v4
      with:
        name: smapi-mod-logs
        path: ModBuilder/output/logs
