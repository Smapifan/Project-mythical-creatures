name: SMAPI Mod Template Builder

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-template:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET 6
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '6.0.x'

      - name: Prepare folders
        run: |
          rm -rf ModBuilder/output
          mkdir -p ModBuilder/output/temp_build
          mkdir -p ModBuilder/output/logs

      - name: Generate Mod Template
        run: |
          set -e
          MOD_NAME="MyModTemplate"
          MOD_PATH="ModBuilder/output/temp_build/$MOD_NAME"
          mkdir -p "$MOD_PATH"

          # ModEntry.cs erstellen
          cat > "$MOD_PATH/ModEntry.cs" <<'EOF'
using StardewModdingAPI;
namespace MyModTemplate {
    public class ModEntry : Mod {
        public override void Entry(IModHelper helper) {
            Monitor.Log("Mod gestartet!", LogLevel.Info);
        }
    }
}
EOF

          # manifest.json erstellen
          cat > "$MOD_PATH/manifest.json" <<EOF
{
  "Name": "$MOD_NAME",
  "Author": "Smapifan",
  "Version": "1.0.0",
  "Description": "Automatisch erstellte Mod Vorlage",
  "UniqueID": "Smapifan.$MOD_NAME",
  "EntryDll": "$MOD_NAME.dll",
  "MinimumApiVersion": "3.0.0"
}
EOF

          # CSProj erstellen
          cat > "$MOD_PATH/$MOD_NAME.csproj" <<EOF
<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <TargetFramework>net6.0</TargetFramework>
    <OutputType>Library</OutputType>
    <GamePath>$GITHUB_WORKSPACE/DLL-Builder/input/stardew</GamePath>
  </PropertyGroup>
  <ItemGroup>
    <PackageReference Include="Pathoschild.Stardew.ModBuildConfig" Version="4.4.0" />
    <PackageReference Include="StardewModdingAPI" Version="3.17.0" />
  </ItemGroup>
</Project>
EOF

          # Solution erstellen und CSProj hinzuf√ºgen
          pushd "$MOD_PATH"
          dotnet new sln --name "$MOD_NAME"
          dotnet sln add "$MOD_NAME.csproj"
          popd

      - name: Build Mod Template
        run: |
          set -e
          CS_PROJECT=$(find ModBuilder/output/temp_build -name "*.csproj" | head -n 1)
          dotnet build "$CS_PROJECT" -c Release -p:GamePath="$GITHUB_WORKSPACE/DLL-Builder/input/stardew" | tee ModBuilder/output/logs/build.log

      - name: Collect Mod Files
        run: |
          set -e
          MOD_PATH=$(dirname $(find ModBuilder/output/temp_build -name "*.csproj" | head -n 1))
          BUILD_OUT=ModBuilder/output/build
          mkdir -p "$BUILD_OUT/$MOD_NAME"
          cp "$MOD_PATH/ModEntry.cs" "$BUILD_OUT/$MOD_NAME/"
          cp "$MOD_PATH/manifest.json" "$BUILD_OUT/$MOD_NAME/"
          cp "$MOD_PATH/$MOD_NAME.csproj" "$BUILD_OUT/$MOD_NAME/"
          cp "$MOD_PATH/$MOD_NAME.sln" "$BUILD_OUT/$MOD_NAME/"
