name: Build Mod Template

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: false
          fetch-depth: 0

      # 2️⃣ Setup .NET 6
      - name: Setup .NET 6
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 6.0.x

      # 3️⃣ Create FAKE Stardew Valley folder
      - name: Create fake Stardew Valley folder
        run: |
          mkdir -p fake-stardew
          touch fake-stardew/StardewValley.dll
          touch fake-stardew/MonoGame.Framework.dll

      # 4️⃣ EXPORT GAME PATH (DAS FEHLT BEI DIR!)
      - name: Set SDV_GAME_PATH
        run: echo "SDV_GAME_PATH=$PWD/fake-stardew" >> $GITHUB_ENV

      # 5️⃣ Restore
      - name: Restore
        run: |
          sln=$(find . -name "*.sln" | head -n 1)
          dotnet restore "$sln"

      # 6️⃣ Build (MIT StardewGamePath)
      - name: Build
        run: |
          sln=$(find . -name "*.sln" | head -n 1)
          dotnet build "$sln" -c Release /p:StardewGamePath="$SDV_GAME_PATH"

      # 7️⃣ Collect logs
      - name: Collect logs
        if: always()
        run: |
          mkdir -p logs
          echo "SDV_GAME_PATH=$SDV_GAME_PATH" > logs/info.txt

      # 8️⃣ Upload artifacts
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: |
            **/bin/Release/**/*.dll
            logs
