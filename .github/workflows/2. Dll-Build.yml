name: DLL Builder Custom Paths

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-dlls:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET 6
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '6.0.x'

      - name: Set Paths
        run: |
          # === CONFIGURE PATHS HERE ===
          INPUT_PATH="DLL-Builder/input/stardew"        # Path where SLNs and CS projects are
          GAME_PATH="DLL-Builder/input/stardew"         # Simulated SMAPI game folder
          LOG_FOLDER="ModBuilder/output/logs"           # Logs folder
          BOT_USER_FILE="BOT_USER.txt"                  # Bot user info file
          mkdir -p "$LOG_FOLDER"

      - name: Configure Git Bot User
        run: |
          source $BOT_USER_FILE
          git config --global user.name "$Name"
          git config --global user.email "$Email"

      - name: Find SLNs and Build
        run: |
          echo "Searching SLNs in $INPUT_PATH..."
          find "$INPUT_PATH" -maxdepth 1 -name "*.sln" | head -n 100 | while read sln; do
            log="$LOG_FOLDER/$(basename "$sln" .sln).log"
            echo "=== Building $sln ===" | tee "$log"
            dotnet build "$sln" /p:GamePath="$GAME_PATH" 2>&1 | tee -a "$log"
            if [ "${PIPESTATUS[0]}" -ne 0 ]; then
              echo "Build failed for $sln. Check $log"
            fi
          done

      - name: Add DLLs & Logs to Repo
        run: |
          git add "$INPUT_PATH"/**/bin/**/*.dll || true
          git add "$LOG_FOLDER" || true
          git commit -m "Update DLLs & logs [skip ci]" || echo "Nothing to commit"
          git push origin main || echo "Push failed, logs still saved"
