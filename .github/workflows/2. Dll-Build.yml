name: DLL Custom Paths

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-dlls:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        dll: [WerewolfStory, LootChestFramework] # Hier deine DLL-Projekte
      fail-fast: false

    env:
      BOT_USER_FILE: ${{ github.workspace }}/BOT_USER.sh
      INPUT_PATH: ${{ github.workspace }}/DLL-Builder/input/stardew
      GAME_PATH: ${{ github.workspace }}/DLL-Builder/input/stardew
      LOG_PATH: ${{ github.workspace }}/DLL-Builder/logs

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Configure Git Bot User
        run: |
          source $BOT_USER_FILE
          git config --global user.name "$Name"
          git config --global user.email "$Email"

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '6.0.x'

      - name: Build DLL
        working-directory: ${{ env.INPUT_PATH }}
        run: |
          # find the solution file automatically
          sln_file=$(find . -name "*.sln" | head -n 1)
          echo "Solution file found: $sln_file"

          # Create log directory
          mkdir -p ${{ env.LOG_PATH }}
          log_file="${{ env.LOG_PATH }}/${{ matrix.dll }}_build.log"

          # Build DLL with simulated GamePath
          dotnet build "$sln_file" \
            -c Release \
            -p:GamePath="${{ env.GAME_PATH }}" \
            > "$log_file" 2>&1 || echo "Build failed, see log"

      - name: Upload DLL
        if: success() || always()
        run: |
          # find DLL output
          dll_file=$(find ${{ env.INPUT_PATH }}/bin/Release -name "${{ matrix.dll }}.dll" | head -n 1)
          if [ -f "$dll_file" ]; then
            cp "$dll_file" ${{ github.workspace }}/DLL-Builder/output/
          fi

      - name: Commit & Push logs and DLL
        run: |
          git add ${{ env.LOG_PATH }}/*
          git add DLL-Builder/output/*
          git commit -m "CI: Add build logs and DLLs for ${{ matrix.dll }}" || echo "Nothing to commit"
          git push
