name: DLL Builder Parallel - Custom Paths

on:
  push:
    branches:
      - main

jobs:
  build-dlls:
    runs-on: ubuntu-latest
    env:
      # Anpassbare Pfade und Dateien
      INPUT_PATH: "DLL-Builder/input/stardew"      # Pfad zu allen DLLs / Projekten
      GAME_PATH: "DLL-Builder/input/stardew"       # Simulierter GamePath für SMAPI Build
      LOG_PATH: "ModBuilder/output/logs"           # Pfad für logs
      BOT_USER_FILE: ".github/bot_user.env"        # Enthält USERNAME & EMAIL
      DOTNET_ROOT: /usr/share/dotnet
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Load Bot User
        run: |
          if [ -f "$BOT_USER_FILE" ]; then
            source "$BOT_USER_FILE"
          else
            echo "BOT_USER_FILE not found!"
            exit 1
          fi

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 6.0.x

      - name: Restore NuGet Packages
        run: |
          echo "Restoring projects..."
          find "$INPUT_PATH" -name "*.sln" | while read sln; do
            dotnet restore "$sln"
          done

      - name: Build Projects (Auto Output)
        run: |
          echo "Building projects..."
          mkdir -p "$LOG_PATH"

          find "$INPUT_PATH" -name "*.sln" | while read sln; do
            echo "Building $sln..."
            OUTPUT_DIR=$(dirname "$sln")/bin/Release/net6.0
            dotnet build "$sln" -c Release /p:GamePath="$GAME_PATH" > "$LOG_PATH/build.log" 2>&1 || true
          done

      - name: Configure Git User
        run: |
          git config user.name "$BOT_NAME"
          git config user.email "$BOT_EMAIL"

      - name: Commit & Push DLLs and Logs
        run: |
          # Sync with remote to prevent fast-forward issues
          git fetch origin main
          git reset --hard origin/main

          # Ensure paths exist
          [ -d "$LOG_PATH" ] || mkdir -p "$LOG_PATH"
          # Add all built DLLs and log
          git add "$INPUT_PATH" "$LOG_PATH"
          git commit -m "Add DLL build output and logs" || echo "Nothing to commit"
          git push origin main
