name: DLL Builder - Custom Paths

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  INPUT_PATH: "ModBuilder/output/build/LootChestFramework"   # folder containing all DLLs / game files
  GAME_PATH: "DLL-Builder/input/stardew"    # simulated game path
  LOG_PATH: "ModBuilder/output/logs"        # log folder
  BOT_USER_FILE: ".github/bot_user.env"     # file containing BOT_NAME and BOT_EMAIL

jobs:
  build-dlls:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Load Bot User
        run: |
          if [ -f "$BOT_USER_FILE" ]; then
            source "$BOT_USER_FILE"
            git config user.name "$BOT_NAME"
            git config user.email "$BOT_EMAIL"
          else
            echo "Bot user file missing!"
            exit 1
          fi

      - name: Setup .NET 6
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '6.0.x'

      - name: Restore Dependencies
        run: |
          echo "Restoring projects..."
          sln_file=$(find $INPUT_PATH -name "*.sln" | head -n 1)
          if [ -z "$sln_file" ]; then
            echo "No solution file found in $INPUT_PATH"
            exit 1
          fi
          dotnet restore "$sln_file"

      - name: Build DLLs
        run: |
          OUTPUT_DIR=$(dirname "$sln_file")/bin/Release/net6.0
          mkdir -p "$OUTPUT_DIR"
          mkdir -p "$LOG_PATH"
          echo "Building $sln_file..."
          # Build solution and capture logs always
          dotnet build "$sln_file" -c Release > "$LOG_PATH/build.log" 2>&1 || true

      - name: Push DLLs and Logs
        run: |
          # Sync with remote to prevent fast-forward errors
          git fetch origin main
          git reset --hard origin/main

          # Add DLLs and logs
          git add "$OUTPUT_DIR" "$LOG_PATH"
          git commit -m "Add DLL build output and logs" || echo "Nothing to commit"
          git push
