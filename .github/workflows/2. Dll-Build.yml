name: DLL Builder Parallel - Custom Paths

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  INPUT_PATH: ModBuilder/output/build/LootChestFramework     # Source .cs/.csproj/.sln path
  GAME_PATH: DLL-Builder/input/stardew      # Simulated Game Path
  LOG_FOLDER: ModBuilder/output/logs        # Folder for individual logs
  BOT_USER_FILE: BOT_USER.txt               # GitHub bot user file

jobs:
  build-dlls:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        sln-file: ${{ fromJson(needs.get-sln.outputs.slns) }}
      fail-fast: false
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Load GitHub bot user
        id: load-bot
        run: |
          source $BOT_USER_FILE
          echo "BOT_NAME=$Name" >> $GITHUB_ENV
          echo "BOT_EMAIL=$Email" >> $GITHUB_ENV

      - name: Set Git config
        run: |
          git config --global user.name "$BOT_NAME"
          git config --global user.email "$BOT_EMAIL"

      - name: Setup .NET 6
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '6.0.x'

      - name: Prepare folders
        run: |
          mkdir -p "$LOG_FOLDER"

      - name: Find SLN files
        id: get-sln
        run: |
          slns=$(find "$INPUT_PATH" -maxdepth 1 -name "*.sln" | jq -R -s -c 'split("\n")[:-1]')
          echo "::set-output name=slns::$slns"

      - name: Build DLLs (parallel)
        run: |
          sln="${{ matrix.sln-file }}"
          log="$LOG_FOLDER/$(basename "$sln" .sln).log"
          echo "Building $sln..."
          dotnet build "$sln" /p:GamePath="$GAME_PATH" >> "$log" 2>&1 || true

      - name: Commit DLLs & Logs
        run: |
          git add "$INPUT_PATH"/**/bin/**/*.dll || true
          git add "$LOG_FOLDER" || true
          git commit -m "Update DLLs & logs [skip ci]" || echo "Nothing to commit"
          git push origin main || echo "Push failed, logs still saved"
