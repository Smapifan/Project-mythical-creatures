name: SMAPI DLL Builder

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # 1Ô∏è‚É£ Repo klonen
    - name: Checkout repo
      uses: actions/checkout@v4

    # 2Ô∏è‚É£ .NET 6 installieren
    - name: Setup .NET 6
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '6.0.x'

    # 3Ô∏è‚É£ Tools
    - name: Install tools
      run: sudo apt-get update && sudo apt-get install -y unzip jq

    # 4Ô∏è‚É£ Ordner vorbereiten
    - name: Prepare folders
      run: |
        rm -rf DLL-Builder/temp_build
        mkdir -p DLL-Builder/temp_build
        mkdir -p DLL-Builder/output/logs

    # 5Ô∏è‚É£ Mod-ZIP entpacken
    - name: Unpack mod source
      run: |
        unzip -o DLL-Builder/input/mods/*.zip -d DLL-Builder/temp_build

    # 6Ô∏è‚É£ Debug: Stardew GamePath pr√ºfen
    - name: Debug GamePath
      run: |
        echo "GamePath contents:"
        ls DLL-Builder/input/stardew

    # 7Ô∏è‚É£ CSProj finden
    - name: Find csproj
      run: |
        CS_PROJECT=$(find DLL-Builder/temp_build -name "*.csproj" | head -n 1)
        echo "Found: $CS_PROJECT"
        echo "CS_PROJECT=$CS_PROJECT" >> $GITHUB_ENV

    # 8Ô∏è‚É£ Build mit GamePath + Log
    - name: Build SMAPI Mod
      run: |
        dotnet build "$CS_PROJECT" -c Release \
          -p:GamePath="$GITHUB_WORKSPACE/DLL-Builder/input/stardew" \
          | tee DLL-Builder/output/logs/build.log

    # 9Ô∏è‚É£ Mod-Name aus manifest.json lesen
    - name: Read mod name
      run: |
        MOD_DIR=$(dirname "$CS_PROJECT")
        MOD_NAME=$(jq -r .Name "$MOD_DIR/manifest.json")
        echo "MOD_NAME=$MOD_NAME" >> $GITHUB_ENV

    # üîü Mod-Dateien sammeln
    - name: Collect mod output
      run: |
        MOD_DIR=$(dirname "$CS_PROJECT")
        BUILD_OUT=DLL-Builder/output/build
        mkdir -p "$BUILD_OUT"

        # DLL kopieren
        find "$MOD_DIR/bin/Release" -name "*.dll" -exec cp {} "$BUILD_OUT" \;

        # Assets kopieren
        if [ -d "$MOD_DIR/Assets" ]; then
          cp -r "$MOD_DIR/Assets" "$BUILD_OUT"
        fi

        # manifest.json
        cp "$MOD_DIR/manifest.json" "$BUILD_OUT"

    # 1Ô∏è‚É£1Ô∏è‚É£ ZIP erstellen
    - name: Create final zip
      run: |
        cd DLL-Builder/output
        zip -r "$MOD_NAME.zip" build

    # 1Ô∏è‚É£2Ô∏è‚É£ Artifact hochladen
    - name: Upload result
      uses: actions/upload-artifact@v4
      with:
        name: smapi-mod
        path: |
          DLL-Builder/output/*.zip
          DLL-Builder/output/logs/build.log
