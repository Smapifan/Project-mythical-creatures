name: SMAPI Mod Template Generator

on:
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest

    env:
      MOD_NAME: LootChestFramework
      OUTPUT_ROOT: ModBuilder/output
      GAME_PATH: DLL-Builder/input/stardew

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '6.0.x'

      - name: Configure git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Prepare output folders
        run: |
          rm -rf "$OUTPUT_ROOT"
          mkdir -p "$OUTPUT_ROOT/build/$MOD_NAME"
          mkdir -p "$OUTPUT_ROOT/logs"

      - name: Create class library
        run: |
          cd "$OUTPUT_ROOT/build/$MOD_NAME"
          dotnet new classlib --name "$MOD_NAME" --framework net6.0

      - name: Create solution
        run: |
          cd "$OUTPUT_ROOT/build/$MOD_NAME"
          dotnet new sln --name "$MOD_NAME"

      - name: Link csproj to solution
        run: |
          dotnet sln "$OUTPUT_ROOT/build/$MOD_NAME/$MOD_NAME.sln" add \
            "$OUTPUT_ROOT/build/$MOD_NAME/$MOD_NAME/$MOD_NAME.csproj"

      - name: Add SMAPI ModBuildConfig package
        run: |
          dotnet add "$OUTPUT_ROOT/build/$MOD_NAME/$MOD_NAME/$MOD_NAME.csproj" \
            package Pathoschild.Stardew.ModBuildConfig --version 4.4.0

      - name: Inject GamePath property
        run: |
          dotnet msbuild "$OUTPUT_ROOT/build/$MOD_NAME/$MOD_NAME/$MOD_NAME.csproj" \
            -p:GamePath="$GITHUB_WORKSPACE/$GAME_PATH" \
            -t:Restore

      - name: Commit and push
        run: |
          git fetch origin main
          git reset --hard origin/main
          git add "$OUTPUT_ROOT"
          git commit -m "Generate SMAPI mod template: $MOD_NAME" || echo "Nothing to commit"
          git push origin main
