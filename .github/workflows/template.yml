name: SMAPI Mod Builder

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # 1️⃣ Repo klonen
    - name: Checkout repo
      uses: actions/checkout@v4

    # 2️⃣ .NET 6 installieren
    - name: Setup .NET 6
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '6.0.x'

    # 3️⃣ Tools installieren
    - name: Install tools
      run: sudo apt-get update && sudo apt-get install -y unzip jq git

    # 4️⃣ Ordner vorbereiten
    - name: Prepare folders
      run: |
        mkdir -p ModBuilder/output/temp_build
        mkdir -p ModBuilder/output/build

    # 5️⃣ Safe directory setzen (verhindert Git exit 128)
    - name: Configure Git safe directory
      run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

    # 6️⃣ Mod Template erstellen
    - name: Create Class Library + Solution
      run: |
        cd ModBuilder/output/temp_build
        dotnet new classlib -n MyModTemplate
        dotnet new sln -n MyModTemplate
        dotnet sln MyModTemplate.sln add MyModTemplate/MyModTemplate.csproj
        cd MyModTemplate
        dotnet add package Pathoschild.Stardew.ModBuildConfig --version 4.4.0

    # 7️⃣ Build durchführen mit GamePath
    - name: Build SMAPI Mod
      run: |
        CS_PROJECT=$(find ModBuilder/output/temp_build -name "*.csproj" | head -n 1)
        dotnet build "$CS_PROJECT" -c Release -p:GamePath="$GITHUB_WORKSPACE/DLL-Builder/input/stardew" | tee ModBuilder/output/build/build.log

    # 8️⃣ Output-Ordner vorbereiten
    - name: Prepare final output
      run: |
        BUILD_OUT=ModBuilder/output/build/MyModTemplate
        mkdir -p "$BUILD_OUT"
        cp -r ModBuilder/output/temp_build/MyModTemplate/bin/Release/* "$BUILD_OUT" || true

    # 9️⃣ Git Commit + Push nur wenn Änderungen
    - name: Commit and push output
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        if [ -n "$(git status --porcelain ModBuilder/output/build)" ]; then
          git add ModBuilder/output/build
          git commit -m "Generated MyModTemplate at $(date +'%Y-%m-%d %H:%M:%S')"
          git push origin main
        else
          echo "Nothing to commit"
        fi
