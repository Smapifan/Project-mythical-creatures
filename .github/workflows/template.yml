name: SMAPI Mod Template Builder

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-template:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Repo klonen
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ .NET 6 installieren
      - name: Setup .NET 6
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '6.0.x'

      # 3️⃣ Ordner vorbereiten
      - name: Prepare folders
        run: |
          rm -rf ModBuilder/output
          mkdir -p ModBuilder/output/temp_build
          mkdir -p ModBuilder/output/logs
          mkdir -p DLL-Builder/input/stardew  # GamePath imitation

      # 4️⃣ Template erstellen (ClassLib, SLN, CSProj)
      - name: Generate template using dotnet commands
        run: |
          MOD_NAME="MyModTemplate"
          MOD_PATH="ModBuilder/output/temp_build/$MOD_NAME"
          mkdir -p "$MOD_PATH"
          cd "$MOD_PATH"

          # 4.1️⃣ Leere Class Library erzeugen
          dotnet new classlib -n "$MOD_NAME"

          # 4.2️⃣ SLN erstellen
          dotnet new sln -n "$MOD_NAME"

          # 4.3️⃣ CSProj zur SLN hinzufügen
          dotnet sln add "$MOD_NAME.csproj"

          # 4.4️⃣ Packages hinzufügen
          dotnet add "$MOD_NAME.csproj" package Pathoschild.Stardew.ModBuildConfig --version 4.4.0
          dotnet add "$MOD_NAME.csproj" package StardewModdingAPI --version 3.17.0

          cd - > /dev/null

      # 5️⃣ Build mit GamePath
      - name: Build Mod Template
        run: |
          CS_PROJECT=$(find ModBuilder/output/temp_build -name "*.csproj" | head -n 1)
          dotnet build "$CS_PROJECT" -c Release -p:GamePath="$GITHUB_WORKSPACE/DLL-Builder/input/stardew" \
            | tee ModBuilder/output/logs/build.log || true

      # 6️⃣ Build Output sammeln
      - name: Collect Mod Template Files
        run: |
          MOD_PATH=$(dirname $(find ModBuilder/output/temp_build -name "*.csproj" | head -n 1))
          BUILD_OUT=ModBuilder/output/build/MyModTemplate
          mkdir -p "$BUILD_OUT"
          cp -r "$MOD_PATH"/* "$BUILD_OUT/"
