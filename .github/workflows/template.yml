name: SMAPI Mod Framework Generator

on:
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest

    env:
      MOD_NAME: LootChestFramework
      OUTPUT_ROOT: ModBuilder/output
      GAME_PATH: DLL-Builder/input/stardew

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Setup .NET 6
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '6.0.x'

    - name: Prepare folders
      run: |
        mkdir -p "$OUTPUT_ROOT/build/$MOD_NAME"
        mkdir -p "$OUTPUT_ROOT/build/$MOD_NAME/$MOD_NAME"

    - name: Create class library (NO nested folders)
      run: |
        cd "$OUTPUT_ROOT/build/$MOD_NAME/$MOD_NAME"
        dotnet new classlib --name "$MOD_NAME" --force

    - name: Create solution on top level
      run: |
        cd "$OUTPUT_ROOT/build/$MOD_NAME"
        dotnet new sln --name "$MOD_NAME"

    - name: Link csproj to solution
      run: |
        cd "$OUTPUT_ROOT/build/$MOD_NAME"
        dotnet sln "$MOD_NAME.sln" add "$MOD_NAME/$MOD_NAME.csproj"

    - name: Add SMAPI build package
      run: |
        cd "$OUTPUT_ROOT/build/$MOD_NAME/$MOD_NAME"
        dotnet add package Pathoschild.Stardew.ModBuildConfig --version 4.4.0

    - name: Create empty SMAPI files
      run: |
        touch "$OUTPUT_ROOT/build/$MOD_NAME/$MOD_NAME/ModEntry.cs"
        touch "$OUTPUT_ROOT/build/$MOD_NAME/$MOD_NAME/manifest.json"

    - name: Commit and push
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        git fetch origin main
        git reset --hard origin/main

        git add "$OUTPUT_ROOT/build/$MOD_NAME"
        git commit -m "Generate SMAPI framework ($MOD_NAME)" || echo "Nothing to commit"
        git push origin main
